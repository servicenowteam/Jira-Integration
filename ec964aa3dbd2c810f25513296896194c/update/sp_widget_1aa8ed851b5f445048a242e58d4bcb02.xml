<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function jiraApprovalList($scope, spModal, $window, spUtil) {
  /* widget controller */
  var c = this;
  spUtil.recordWatch($scope, $scope.data.table, $scope.data.filter, function (response) {
    if (response.data.operation === 'insert') {
      $scope.data.approval = undefined;
      $scope.server.update().then(function (data) {
        $scope.approvals = data.approvals;
      });
    }
  });
  $scope.approvals = $scope.data.approvals;

  $scope.onListItemClicked = function ($event, link) {
    $event.preventDefault();
    $event.stopPropagation();
    $window.location.href = link;
  };

  $scope.onApprovalClicked = function ($event, approval) {
    $event.preventDefault();
    $event.stopPropagation();
    spModal.open({
      title: 'Approval Confirmation',
      message: 'Confirm you would like to approve ' + approval.number + '.'
    }).then(function (confirmed) {
      if (confirmed) {
        $scope.data.approval = approval.sys_id;
        $scope.server.update().then(function (data) {
          $scope.approvals = $scope.approvals.filter(function (item) {
            return item.sys_id !== approval.sys_id;
          });
          $scope.data.approval = undefined;
        });
      }
    });
  };

  $scope.truncate = function (str) {
    if (!str) return;

    if (typeof str !== 'string') return;

    if (str.length > 20) {
      return str.slice(0, 20) + '...';
    }
    return str;
  };
}]]></client_script>
        <controller_as>c</controller_as>
        <css>::-webkit-scrollbar {&#13;
  width: 0.2em;&#13;
}&#13;
 &#13;
::-webkit-scrollbar-track {&#13;
  box-shadow: inset 0 0 0.5px rgba(0, 0, 0, 0.1);&#13;
}&#13;
 &#13;
::-webkit-scrollbar-thumb {&#13;
  background-color: rgba(0, 0, 0, 0.2);&#13;
  border-radius: 0.5em;&#13;
  outline: 0.5px solid #eee;&#13;
}&#13;
&#13;
@media screen and (max-width: 600px) {&#13;
  ::-webkit-scrollbar {&#13;
    width: 0em;&#13;
  }&#13;
   &#13;
  ::-webkit-scrollbar-track {&#13;
    box-shadow: inset 0 0 0.5px rgba(0, 0, 0, 0.1);&#13;
  }&#13;
   &#13;
  ::-webkit-scrollbar-thumb {&#13;
    background-color: rgba(0, 0, 0, 0.1);&#13;
    border-radius: 0.1em;&#13;
    outline: 0.5px solid #eee;&#13;
  }&#13;
}&#13;
.icon-xs {&#13;
  width: 20px;&#13;
  height: 20px;&#13;
}&#13;
&#13;
.panel {&#13;
  margin-bottom: 10px;&#13;
}&#13;
&#13;
.btn-c-f {&#13;
  display: flex;&#13;
  align-items: center;&#13;
  justify-content: center;&#13;
}&#13;
&#13;
.panel-body {&#13;
  max-height: 300px;&#13;
  overflow-y: auto;&#13;
  padding: 0px;&#13;
}&#13;
&#13;
.centered {&#13;
  text-align: center;&#13;
  align-items: center;&#13;
  justify-content: center;&#13;
}&#13;
&#13;
.approval-list-group {&#13;
  margin-bottom: 0px;&#13;
}&#13;
&#13;
.list-group-item {&#13;
  padding-bottom: 10px;&#13;
  border-left: 1px solid transparent;&#13;
  border-right: 1px solid transparent;&#13;
  background: inherit;&#13;
  border-radius: 0px;&#13;
&#13;
  &amp;:hover {&#13;
    background: #f5f5f5;&#13;
    text-decoration: underline;&#13;
    transition: all 0.2s ease;&#13;
  }&#13;
&#13;
  &amp;:first-child {&#13;
    border-top: 1px solid transparent;&#13;
  }&#13;
&#13;
  &amp;:nth-child(even) {&#13;
    border-bottom: 1px solid transparent;&#13;
    border-top: 1px solid transparent;&#13;
  }&#13;
  &#13;
&#13;
  &amp;:last-child {&#13;
    border-bottom: 1px solid transparent;&#13;
  }&#13;
  &amp;.list-group-clear {&#13;
    border: 1px solid transparent;&#13;
    border-radius: 0px;&#13;
  }&#13;
}&#13;
&#13;
.line-height {&#13;
  &amp;-md {&#13;
    line-height: 2;&#13;
  }&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>jira-approval-list</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Jira Approval List</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
  data.table = (input ? input.table : undefined) || options.table || $sp.getParameter('table');
  data.canApprove = gs.hasRole('x_momo_jira_integr.issue_tech');
  data.filter = 'active=true^approval=not requested';
  if (!data.canApprove) {
    data.filter += '^requested_for=' + gs.getUserID();
  }
  data.approval = (input ? input.approval : undefined);

  if (data.approval) {
    approveJiraIssue(data.table, data.approval, data.canApprove);
  }

  data.approvals = createApprovalsList(data.table, data.filter);

  function approveJiraIssue(table, sys_id, canApprove) {
    if (!canApprove) return;
    var gr = new GlideRecord(table);

    gr.get(sys_id);

    if (gr.isValid()) {
      gr.setValue('approval', 'approved');
      gr.work_notes = 'Approved by ' + gs.getUserDisplayName();
      gr.update();
    }
    return;
  }

  function createApprovalsList(table, filter) {
    var approvals = [];
    var gr = new GlideRecord(table);
    gr.addEncodedQuery(filter);
    gr.query();
    while (gr.next()) {
      approvals.push({
        link: '?id=jira_issues_form&action=2&table=' + gr.getTableName() + '&sys_id=' + gr.getUniqueValue(),
        number: gr.getValue('number'),
        project: {
          name: gr.project.name.toString(),
          key: gr.project.external_key.toString()
        },
        priority: {
          icon: gr.priority.icon.toString(),
          name: gr.priority.name.toString()
        },
        request_type: {
          icon: gr.issue_type.icon.toString(),
          name: gr.issue_type.name.toString()
        },
        short_description: gr.getValue('short_description'),
        sys_id: gr.getUniqueValue(),
        requested_for: {
          name: gr.getDisplayValue('requested_for'),
          sys_id: gr.getValue('requested_for')
        }
      });
    }
    return approvals;
  }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>douglas.schamberg</sys_created_by>
        <sys_created_on>2020-02-29 10:33:43</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>1aa8ed851b5f445048a242e58d4bcb02</sys_id>
        <sys_mod_count>102</sys_mod_count>
        <sys_name>Jira Approval List</sys_name>
        <sys_package display_value="Jira Integration" source="x_momo_jira_integr">ec964aa3dbd2c810f25513296896194c</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Jira Integration">ec964aa3dbd2c810f25513296896194c</sys_scope>
        <sys_update_name>sp_widget_1aa8ed851b5f445048a242e58d4bcb02</sys_update_name>
        <sys_updated_by>douglas.schamberg@movement.com</sys_updated_by>
        <sys_updated_on>2020-08-20 10:22:37</sys_updated_on>
        <template><![CDATA[<div class="panel panel-default">
  <div class="panel-heading">
    <div class="panel-title centered" ng-if="data.canApprove">
      ${Approvals Needed}
    </div>
    <div class="panel-title centered" ng-if="!data.canApprove">
      ${Awaiting Approval}
    </div>
  </div>
  <div class="panel-body">
    <ul class="list-group approval-list-group">
      <li class="list-group-item"
        ng-if="approvals.length > 0"
        ng-click="onListItemClicked($event, approval.link)"
        ng-repeat="approval in approvals track by approval.sys_id">
        <div class="row">
          <div class="col-xs-1 hidden-xs">
            <img class="icon-xs" 
              ng-src="{{ approval.request_type.icon }}" 
              title="{{ approval.request_type.name }}"
              alt="{{ approval.request_type.name }}" />
          </div>
          <div class="col-xs-2 centered padder-r-sm">
            <span class="text-muted line-height-md"
              uib-tooltip="{{ approval.project.name }}"
              tooltip-placement="top"
              tooltip-append-to-body="true">{{ approval.project.key }}</span>
          </div>
          <div class="col-xs-6">
            <span class="text-muted" ng-if="approval.short_description" ng-bind="truncate(approval.short_description)"></span>
            <span class="text-muted" ng-if="!approval.short_description">{{ approval.number }}</span>
          </div>
          <div class="hidden-xs" ng-class="{'col-xs-1': data.canApprove, 'col-xs-3': !data.canApprove}">
            <img class="icon-xs"
              ng-class="{'pull-right': !data.canApprove}" 
              ng-src="{{ approval.priority.icon }}" 
              title="{{ approval.priority.name }}"
              alt="{{ approval.priority.name }}" />
          </div>
          <div class="col-xs-2 padder-r-none padder-l-none btn-c-f" ng-if="data.canApprove">
            <button class="btn btn-sm btn-primary" ng-click="onApprovalClicked($event, approval)">Approve</button>
          </div>
        </div>
      </li>
      <div class="list-group-item list-group-clear" ng-if="approvals.length === 0">
        <div class="centered" ng-if="data.canApprove">
          ${No approvals needed}
        </div>
        <div class="centered" ng-if="!data.canApprove">
          ${No awaiting approvals}
        </div>
      </div>
    </ul>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
